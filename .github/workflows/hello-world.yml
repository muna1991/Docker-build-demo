name: Build Multiple Docker Images

on:
  push:
    branches:
      - main

jobs:
  parse-config:
    name: parse configuration
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: parse docker-config.yaml
        id: parse-config
        run: |
          config=$(cat docker-config.yaml | yq -o=json)
          echo "matrix=$(echo $config | jq -c '.environments')" >> $GITHUB_OUTPUT

  docker-build:
    needs: parse-config
    runs-on: self-hosted
    strategy:
      matrix:
        config: ${{ fromJson(needs.parse-config.outputs.matrix) }}
    steps:
      - name: checkout code
        uses: actions/checkout@v3
      - name: Build and tag Docker Image
        run: |
          docker build -t ${{ matrix.config.tag }} -f ${{ matrix.config.dockerfile }} .    
  
      